
Lab Link:
https://portswigger.net/web-security/nosql-injection/lab-nosql-injection-bypass-authentication



PortSwigger Description:


The login functionality for this lab is powered by a MongoDB NoSQL database. It is vulnerable to NoSQL injection using MongoDB operators.

To solve the lab, log into the application as the `administrator` user.

You can log in to your own account using the following credentials: `wiener:peter`.


PortSwigger Solution:
1. In Burp's browser, log in to the application using the credentials `wiener:peter`.
    
2. In Burp, go to **Proxy > HTTP history**. Right-click the `POST /login` request and select **Send to Repeater**.
    
3. In Repeater, test the username and password parameters to determine whether they allow you to inject MongoDB operators:
    
    1. Change the value of the `username` parameter from `"wiener"` to `{"$ne":""}`, then send the request. Notice that this enables you to log in.
    2. Change the value of the username parameter from `{"$ne":""}` to `{"$regex":"wien.*"}`, then send the request. Notice that you can also log in when using the `$regex` operator.
    3. With the username parameter set to `{"$ne":""}`, change the value of the password parameter from `"peter"` to `{"$ne":""}`, then send the request again. Notice that this causes the query to return an unexpected number of records. This indicates that more than one user has been selected.
4. With the password parameter set as `{"$ne":""}`, change the value of the username parameter to `{"$regex":"admin.*"},` then send the request again. Notice that this successfully logs you in as the admin user.
    
5. Right-click the response, then select **Show response in browser**. Copy the URL.
    
6. Paste the URL into Burp's browser to log in as the `administrator` user. The lab is solved.

Instructor Lab Notes:



We go ahead and start up the lab, grab the credentials from the lab, and we go ahead and generate traffic for burp suite is by logging in as wiener using the password peter.

We check burp suite and we check the POST request with the URL called "/login"

there we see the following object in the request:

{
"username": "wiener"
"password": "peter"
}

This is where we are going to want to inspect further so we do ctrl+r to send it to repeater.

So now we start to inject our payloads.

so we change the object in the request as this:



{
"username": {"$regex": "admin.*" }

"password": {"$ne":""}
}

The instructor tells us to read the MongoDB documentation:

# $regex

(https://www.mongodb.com/docs/manual/reference/operator/query/regex/#-regex "Permalink to this heading")

## Note

This page describes regular expression search capabilities for self-managed (non-Atlas) deployments. For data hosted on MongoDB Atlas, MongoDB offers an improved full-text search solution, [Atlas Search](https://www.mongodb.com/docs/atlas/atlas-search/), which has its own `$regex` operator. To learn more, see [$regex](https://www.mongodb.com/docs/atlas/atlas-search/regex/) in the Atlas Search documentation.

## Definition[

](https://www.mongodb.com/docs/manual/reference/operator/query/regex/#definition "Permalink to this heading")

`$regex`[

](https://www.mongodb.com/docs/manual/reference/operator/query/regex/#mongodb-query-op.-regex "Permalink to this definition")

Provides regular expression capabilities for pattern matching _strings_ in queries.

## Compatibility[

](https://www.mongodb.com/docs/manual/reference/operator/query/regex/#compatibility "Permalink to this heading")

You can use `$regex` for deployments hosted in the following environments:

- [MongoDB Atlas](https://www.mongodb.com/docs/atlas?tck=docs_server): The fully managed service for MongoDB deployments in the cloud
    

- [MongoDB Enterprise](https://www.mongodb.com/docs/manual/administration/install-enterprise/#std-label-install-mdb-enterprise): The subscription-based, self-managed version of MongoDB
    
- [MongoDB Community](https://www.mongodb.com/docs/manual/administration/install-community/#std-label-install-mdb-community-edition): The source-available, free-to-use, and self-managed version of MongoDB
    

## Syntax

(https://www.mongodb.com/docs/manual/reference/operator/query/regex/#syntax "Permalink to this heading")

To use `$regex`, use one of the following syntaxes:

```
{ <field>: { $regex: /pattern/, $options: '<options>' } }{ "<field>": { "$regex": "pattern", "$options": "<options>" } }{ <field>: { $regex: /pattern/<options> } }
```

## Note

To use `$regex` with [`mongodump`](https://www.mongodb.com/docs/database-tools/mongodump/#mongodb-binary-bin.mongodump), you must enclose the query document in single quotes ('{ ... }') to ensure that it does not interact with your shell environment.

The query document must be in [Extended JSON v2](https://www.mongodb.com/docs/manual/reference/mongodb-extended-json/#std-label-mongodb-extended-json-v2) format (either relaxed or canonical/strict mode), which includes enclosing the field names and operators in quotes. For example:

```
mongodump -d=sample_mflix -c=movies  -q='{"year": {"$regex": "20"}}'
```

In MongoDB, you can also use regular expression objects (i.e. `/pattern/`) to specify regular expressions:

```
{ <field>: /pattern/<options> }
```

For restrictions on particular syntax use, see [$regex vs. /pattern/ Syntax.](https://www.mongodb.com/docs/manual/reference/operator/query/regex/#std-label-syntax-restrictions)


Ok then we go ahead we send the request to the web application in repeater with our new payloads

and we get a 302 Found and we get a new Cookie

Set-Cookie: session=1mb8NXDw0xLDS3b0XwefljyozqGW4Tj0;

we are going to assume that this cookie belongs to the administrator that we found with our payload so we grab that cookie and copy it.

We go back to the lab web application, we log into Wiener with the password peter

and once we login we go to the console, we go to the Application tab, we go to the Storage Cookies and we see that we have a Name, Value

We replace the value with our Cookie we got from Burp Suite, we update the cookie with the admin one

We once we replace it we go to the URL of the portswigger lab

we replace the current endpoint

my-account?id=wiener

and we replace it with 

my-account

we hit enter and we solve the lab

We see that we are now logged in and solved the lab the username is

Your username is: admindpiqergu

We completed the Lab!

The edge case here was that we assumed the username is administrator however that was not the case, so we had to use regex to see if we can just use or find any username that just had the start of the string as admin and it turns out that the admin name was something else we just didn't know what it was.

