
# NoSQL Injection (MongoDB) – Bypass Authentication Using Operators

**High-Level Summary:**  
These notes focus on exploiting a **_NoSQL injection_** vulnerability (specifically MongoDB) to bypass authentication and log in as an administrator user. Unlike traditional SQL, MongoDB uses JSON-like query structures and supports operators like `$regex` and `$ne`. By manipulating these operators in the authentication request, an attacker can trick the application into returning data for unintended users, effectively bypassing login checks.

---

**Definition Table:**

| Term/Concept        | Definition/Explanation                                                                                         |
|---------------------|-----------------------------------------------------------------------------------------------------------------|
| **_NoSQL Injection_** | A class of injection attacks targeting NoSQL databases, exploiting their query syntax or operators to manipulate database responses. |
| **_MongoDB_**         | A popular NoSQL database that stores data in JSON-like documents. It uses operators like `$ne` and `$regex` to query data. |
| **_{$ne: ""}_**      | A MongoDB query operator that means “not equal to an empty string.” When injected, it can match all documents where the field is not empty. |
| **_{$regex: "pattern"}_** | A MongoDB query operator that matches documents where the field’s value matches a given regular expression pattern. Useful for broad user matches. |
| **_Authentication Bypass_** | Using injection or manipulation techniques to log in as a user without knowing their correct credentials. |
| **_Burp Repeater_**   | A Burp Suite tool that allows manual modification and repeated sending of requests to observe how the server responds. |
| **_302 Found_**       | An HTTP status code indicating a redirect. Often returned when login is successful, redirecting to a logged-in page. |

---

# PortSwigger Lab Description (Original Source)

> This lab’s login uses a MongoDB database. It’s vulnerable to NoSQL injection. By using MongoDB operators (like `$ne` and `$regex`), you can bypass normal authentication checks and log in as the `administrator` user.  
>  
> **Goal:** Log in as the `administrator` user.

**Provided Creds:**  
- User credentials you own: `wiener:peter`

---

# PortSwigger Official Solution (Summary)

1. Log in as `wiener:peter`.
2. Send the `POST /login` request to Repeater.
3. Inject MongoDB operators into username/password fields to find a condition that always returns true.
4. Use `$ne` and `$regex` to bypass authentication:
   - Try `{"$ne":""}` for username and password to get multiple matches.
   - Adjust `$regex` to match `admin` starting substring: `{"$regex":"admin.*"}`
5. Successfully log in as the administrator user.

---

# Instructor Lab Notes (Original) – Fully Detailed and Reformatted

> **Note:** These are the instructor’s original notes, organized with added context (*in italics*) for clarity.

## Step 1: Initial Setup and Proxy Capture

- **Generate Traffic:** Log in as `wiener` with password `peter` through the lab’s front page. This request will be visible in Burp Suite.
- In Burp, locate the `POST /login` request.

The request body might look like:
```json
{
  "username": "wiener",
  "password": "peter"
}
````

## Step 2: Send to Repeater

- Right-click the `/login` request → **Send to Repeater**.
- In Repeater, you can now modify the request and resend it to see the server response.

## Step 3: Testing NoSQL Injection Operators

- MongoDB queries can use `$ne` (not equal) and `$regex` (regular expression) operators.
    
- Replace `username` value with something like:
    
    ```json
    "username": { "$ne": "" }
    ```
    
    and keep `"password": "peter"`.
    
- Send the request. If this logs you in or changes the response (e.g., you get a 302 redirect), you know injection is working.
    

**Why `$ne`?**  
`$ne` ensures that the query matches any document where username is not equal to an empty string. This often returns unexpected matches, like multiple users.

## Step 4: Broadening the Attack with `$regex`

- Next, test a regex pattern. For example:
    
    ```json
    "username": { "$regex": "wien.*" }
    ```
    
    If this still logs you in, it confirms that `$regex` works.
    
- Now try making both fields match multiple users by using `$ne` in the password:
    
    ```json
    "username": { "$ne": "" },
    "password": { "$ne": "" }
    ```
    
    If the response suggests multiple records are matched (for example, you still get a successful login, possibly as another user), you’re on the right track.
    

## Step 5: Targeting the Administrator User

- The lab states we need to log in as `administrator`. We might not know the exact username, but we guess it starts with `admin`.
    
- Use `$regex` to match any user starting with `admin`:
    
    ```json
    "username": { "$regex": "admin.*" },
    "password": { "$ne": "" }
    ```
    
- Send the request. If it succeeds (e.g., returns a 302 redirect), you have effectively logged in as the admin user. The server sets a new session cookie for the admin account.
    

**Key Insight:**  
`$regex` allows partial matches, so even if the admin username isn’t exactly `administrator`, any username beginning with `admin` matches.

## Step 6: Using the New Session Cookie

- After a successful login attempt, check the response headers for a `Set-Cookie: session=...` header.
- Copy this cookie.
- In Burp’s browser or your normal browser, replace your current session cookie with this new one.
- Refresh the user profile page (`/my-account`) to confirm you are now logged in as the admin user.

**Note:** The instructor mentions that the admin username might not be exactly `administrator`. The `$regex` operator helps find any user starting with `admin`.

---

# Exam Readiness & Actionable Methodology

## Methodology Workflow

1. **Recon**: Identify that the application uses MongoDB and thus might accept JSON objects as inputs.
2. **Test Basic Injection**: Try `$ne` to see if you can bypass user existence checks.
3. **Refine Injection**: Use `$regex` to target specific usernames (`admin.*`) and `$ne` on password to match any non-empty password.
4. **Confirm Login**: Check for `302` redirect and new session cookie to confirm successful login as admin.
5. **Post-Exploitation**: Replace your current session cookie with the admin cookie to access admin functionalities.

## Troubleshooting Advice

- If `$ne` or `$regex` don’t work, try different operators from MongoDB’s documented query operators.
- Ensure the JSON syntax is correct. Properly quote field names and operators.
- If the server returns errors, try alternative comment or payload structures.

## Key Takeaways

- NoSQL injections differ from SQL injections but share similar logic: trick the query into returning unintended results.
- `$regex` is powerful because it can broaden or narrow down matches easily.
- Even without knowing the exact admin username, pattern matching can help guess and match the admin user.

---

# What to Do Next (Exam Simulation)

- Practice using `$ne`, `$regex`, and other MongoDB operators on test applications.
- Familiarize yourself with MongoDB query syntax to quickly craft effective payloads.
- Keep a reference of common NoSQL injection techniques.

---

**_Areas Needing Further Clarification_**:

- Other MongoDB query operators that can be useful in different contexts.
- Distinguishing between different NoSQL databases’ operators (MongoDB, CouchDB, etc.).

**_Further Research_**:

- More PortSwigger NoSQL injection labs.
- MongoDB documentation on query operators (`$gt`, `$lt`, `$in`, etc.).
- Articles on advanced NoSQL injection techniques.

---

# Relevant Hashtags

#NoSQLInjection #MongoDB #Regex #BurpSuite #WebHacking #ExamPrep