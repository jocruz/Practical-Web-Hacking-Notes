
---

# **üìö Exploiting XXE Using External Entities to Retrieve Files**

## **üí° Quick Overview**

1. **What is XXE?**
    
    - An **XML External Entity (XXE)** attack exploits improperly configured XML parsers that allow external entities to be defined and referenced. This can lead to unauthorized file access or even remote code execution.
2. **Payload Explanation**:
    
    - The malicious payload defines an external entity (`xxe`) that references a file on the server (e.g., `/etc/passwd`):
        
        ```xml
        <!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
        <stockCheck>
            <productId>&xxe;</productId>
        </stockCheck>
        ```
        
    - **How it works**:
        - The `<!ENTITY>` tag defines `xxe` as pointing to the file `/etc/passwd`.
        - When the application processes the `productId` value (`&xxe;`), it fetches the contents of `/etc/passwd` and includes them in the server's response.
3. **Steps to Exploit**:
    
    - Intercept the `POST /stockCheck` request.
    - Inject the payload into the XML body.
    - Send the request and review the response for the retrieved file contents.
4. **Key Takeaway**:
    
    - XXE vulnerabilities occur due to insecure XML parsing. This lab demonstrates how malicious entities can be used to exfiltrate sensitive files.

The **three slashes (`///`)** in the file path `file:///etc/passwd` are part of the URL syntax for the **file scheme**. Let me break it down:

### Why Three Slashes?

- The `file://` scheme is used to represent local files in a URI format.
- The **third slash (`/`)** separates the scheme (`file://`) from the root of the filesystem (`/` on Unix-based systems like Linux and macOS).

### How it Works

1. `file://` is the scheme, indicating that this is a file resource.
2. The first `/` after `file://` is required by the URI format to signal the beginning of the hierarchical part of the path.
3. The second and third slashes (`//`) are combined to point to the absolute path `/etc/passwd` (a Unix/Linux file).

### Examples of File URLs:

- **Unix/Linux/macOS:** `file:///etc/passwd`
    - Translates to `/etc/passwd` on the filesystem.
- **Windows:** `file:///C:/Users/John/Documents/file.txt`
    - Translates to `C:\Users\John\Documents\file.txt`.

The triple slash format is necessary for URLs to distinguish between hierarchical paths (like files on the local filesystem) and other non-hierarchical URL schemes.

---

## **üõ†Ô∏è Lab Goal**

- **Objective**: Exploit an XXE vulnerability to retrieve sensitive files (e.g., `/etc/passwd`) from the server.

---

## **üöÄ Solution Summary**

### **1Ô∏è‚É£ Intercept the Stock Check Request**

- Visit a product page and click **Check stock**.
- Use **Burp Suite** to intercept the resulting `POST /stockCheck` request.

### **2Ô∏è‚É£ Craft and Inject the Payload**

- Modify the intercepted XML request to include the XXE payload:
    
    ```xml
    <!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
    <stockCheck>
        <productId>&xxe;</productId>
    </stockCheck>
    ```
    

### **3Ô∏è‚É£ Send the Request**

- Send the modified request via Burp Repeater.
- Review the response. If successful, it will contain the contents of `/etc/passwd`.

---

## **üìå Key Takeaways**

### **1Ô∏è‚É£ How the Payload Works**

- **Entity Definition**:  
    `<!ENTITY xxe SYSTEM "file:///etc/passwd">` defines an entity `xxe` that fetches the file `/etc/passwd`.
- **Entity Reference**:  
    The value `&xxe;` in the `productId` field triggers the application to resolve the entity and fetch the file.

### **2Ô∏è‚É£ Why This Attack Succeeds**

- The XML parser processes external entities without restrictions, allowing attackers to fetch server-side files.

### **3Ô∏è‚É£ Mitigation Best Practices**

- Disable external entity processing in XML parsers.
- Use alternative data formats like JSON where possible.
- Validate and sanitize all user inputs.

---

## **üîÑ Steps to Complete the Lab**

### **1Ô∏è‚É£ Identify XML Parsing**

- Click **Check stock** to trigger a request.
- Use Burp Suite to inspect the request format. Look for XML in the body.

### **2Ô∏è‚É£ Send Request to Repeater**

- Intercept the `POST /stockCheck` request.
- Send it to **Repeater** for testing.

### **3Ô∏è‚É£ Inject the XXE Payload**

- Modify the XML body as follows:
    
    ```xml
    <!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
    <stockCheck>
        <productId>&xxe;</productId>
    </stockCheck>
    ```
    

### **4Ô∏è‚É£ Analyze the Response**

- Send the modified request and review the server response.
- Look for the contents of `/etc/passwd`.

---

## **‚ö†Ô∏è Troubleshooting**

### **1Ô∏è‚É£ No File Contents in Response**

- Ensure the XML syntax is correct.
- Test with other files (e.g., `/home/user/.ssh/id_rsa`).

### **2Ô∏è‚É£ Server Rejects the Payload**

- Try alternate entity definitions (e.g., parameter entities or XInclude).
- Check if the server blocks specific file paths.

---